# 人机协同成长产品架构设计

## 目标与愿景
- **普惠成长**：以 12×12 的每日时间网格唤醒用户对剩余时间的感知，帮助他们把握 AI 带来的辅力。
- **共创体验**：围绕“思考 / 斋戒 / 等待”三种模式，与 AI 协作制定计划、执行行动、复盘成长。
- **自适应 AI**：沉淀交互数据形成“成长档案”，驱动 RAG 和提示词调优，持续匹配用户的节奏与表达偏好。

## 用户旅程
1. 打开页面看到 144 个十分钟方块，实时展示已过去与剩余时间。
2. 输入当天意图/愿望，反思想把剩余时间用在何处。
3. 根据脑力、体力与疲惫状态，选择“思考”“斋戒”“等待”之一。
4. 获得对应助手的建议、行动清单或休息引导，并在流程中记录反馈。
5. 互动数据写入成长档案，供后续 RAG 检索与模型调优使用。

## 信息架构
- **Time Grid Layer**：时间可视化与剩余时间提醒。
- **Mode & Assistant Layer**：模式选择、AI 助手响应、任务推进。
- **Growth Archive Layer**：记录意图、模式、反馈与能量状态，持续构建画像。
- **Telemetry & RAG Layer**：收集行为事件、发送至后端 RAG 与模型服务。

## 页面与组件
- 新增 `app/(tabs)/time-collab.tsx` 作为主页面。
- 拆分组件：
  - `TimeGrid`：渲染 12×12 网格，展示进度与当前时间刻度。
  - `IntentionPrompt`：提示输入愿望/意图。
  - `ModeSelector`：吐司/按钮式切换三种模式，显示能量提示。
  - `AssistantPanel`：根据模式展示 AI 建议、行动项与反馈入口。
  - 基础件 `components/ui/grid-tile.tsx`、`components/ui/mode-chip.tsx` 提供复用样式。
- 调整 `app/(tabs)/_layout.tsx` 与 `app/(tabs)/index.tsx`，在底部导航暴露新入口并提供宣传卡片。

## 状态与上下文
- 新建 `contexts/user-collab-context.tsx`：
  - 保存今日意图、当前模式、能量评分、已完成行动。
  - 暴露读写函数给页面及助手面板。
- `hooks/useDailyGrid.ts`：计算当前十分钟索引、剩余时间，驱动网格刷新。
- `hooks/useAssistant.ts`：封装助手请求、缓存最新建议、管理加载/错误状态。
- `hooks/useGrowthLog.ts`：负责交互记录落地与离线重试。
- 状态初始化时读取本地缓存（`AsyncStorage` 或 Expo SecureStore），并在模式切换时触发新的助手请求。

## 服务与 API
- `services/ai/rag-client.ts`：对接后端检索接口 `POST /rag/query`，传入：
  - 用户 ID、当前日期、模式、意图摘要。
  - 最近交互片段（来自成长档案）。
  - 期望返回：上下文片段数组、推荐提示词调优信息。
- `services/ai/assist.ts`：根据模式生成提示词模板，合并 RAG 结果并请求生成接口 `POST /assist/complete`。
- `services/telemetry.ts`：发送用户行为事件（模式切换、任务完成、反馈评分）。支持批量与退避重试。
- `utils/storage.ts`：抽象本地存储读写、节流上传。
- 提供 mock 服务以便离线开发（如 `services/ai/mock-data.ts`）。

## 数据模型
```ts
type GrowthEntry = {
  date: string;
  mode: 'think' | 'fast' | 'rest';
  intention: string;
  energyLevel: 'high' | 'medium' | 'low';
  aiResponse: string;
  userAction?: string;
  feedback?: { rating: number; note?: string };
};
```
- 客户端按日期维护 `GrowthEntry[]`，每日汇总上传。
- 后端将意图、反馈等内容切分向量片段，写入向量库并更新 `profiles/{userId}`（语气偏好、常见目标、疲劳阈值）。

## RAG 与提示词策略
- 检索维度：相似意图、模式、能量状态、近期失败案例。
- 提示词模板示例：
  - **思考**：聚焦目标定义、拆解路径、识别阻碍。
  - **斋戒**：强调行动约束、最小化干扰、提供倒计时。
  - **等待**：引导休息、正念提醒、补充能量建议。
- 根据用户反馈（评分/文字）调整提示词语气与长度，纳入“成长”维度。

## 交互记录与隐私
- 默认开启数据记录，提供设置入口允许用户暂停上传或清除历史。
- 上传前对敏感字段做脱敏（如人名、项目名，用占位符替换）。
- 与后端协定数据保留策略和删除接口。

## UI/UX 注意点
- 网格随时间推进自动填充，可在当前格显示闪烁或脉冲动画。
- 剩余时间提示放置于页面顶部，搭配引导文案激发思考。
- 模式选择考虑快捷入口（如底部滑块）与辅助说明 tooltip。
- 助手面板支持多段回应：建议列表、下一步行动、鼓励语。
- 提供“切换模式”与“完成/跳过”快捷操作，保持低认知负担。

## 测试与验证
- 单元测试：网格计算、模式状态 reducer、服务请求封装。
- 集成测试（可用 React Native Testing Library）：模拟模式切换、助手响应、错误提示。
- 手动验证：修改系统时间检查网格刷新；断网场景验证本地缓存与重试；多次交互后查看 RAG 返回是否贴合历史。

## 技术债与后续规划
- 将成长档案与用户画像抽象为独立 SDK，支持多端共用。
- 引入情绪识别或语音输入，丰富模式选择维度。
- 结合硬件传感（心率、步数）优化能量状态评估。
- 后续可扩展到团队协同模式，共享时间网格与共创目标。

